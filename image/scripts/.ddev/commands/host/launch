#!/usr/bin/env bash

## Description: Show Coder URLs for this DDEV project (replaces browser-open in cloud)
## Usage: launch [path] [-m|--mailpit]
## Example: "ddev launch" or "ddev launch /admin" or "ddev launch -m"
## Flags: [{"Name":"mailpit","Shorthand":"m","Usage":"ddev launch -m shows the Mailpit URL"}]

# Outside a Coder workspace fall back to a basic URL print (no browser available in DinD)
if [ -z "${CODER_WORKSPACE_NAME:-}" ] || [ -z "${VSCODE_PROXY_URI:-}" ]; then
  echo "Primary URL: ${DDEV_PRIMARY_URL:-unknown}"
  echo "(Not running in a Coder workspace; cannot open a browser.)"
  exit 0
fi

WORKSPACE="${CODER_WORKSPACE_NAME}"
OWNER="${CODER_WORKSPACE_OWNER_NAME}"
DOMAIN=$(echo "${VSCODE_PROXY_URI}" | sed -E 's|https?://[^.]+\.(.+?)(/.*)?$|\1|')

# DDEV_SITENAME is the DDEV project name (may differ from the Coder workspace name).
# Coder URLs always use WORKSPACE (= CODER_WORKSPACE_NAME); PROJECT is only used
# to look up router keys in coder-routes.yaml (which coder-routes prefixes with DDEV_PROJECT).
PROJECT="${DDEV_SITENAME}"
AGENT="${CODER_AGENT_NAME:-main}"

MAILPIT=false
PATH_SUFFIX=""

while :; do
  case ${1:-} in
  -m | --mailpit | --mailhog)
    MAILPIT=true
    ;;
  --) shift; break ;;
  -?*) printf 'WARN: Unknown option (ignored): %s\n' "$1" >&2 ;;
  *) break ;;
  esac
  shift
done

if [ -n "${1:-}" ]; then
  PATH_SUFFIX="/${1#/}"
fi

if [ "${MAILPIT}" = "true" ]; then
  echo "https://mailpit--${WORKSPACE}--${OWNER}.${DOMAIN}"
  exit 0
fi

echo ""
echo "Coder URLs for project '${PROJECT}':"
echo "  Web:     https://${WORKSPACE}--${WORKSPACE}--${OWNER}.${DOMAIN}${PATH_SUFFIX}"
echo "  Mailpit: https://mailpit--${WORKSPACE}--${OWNER}.${DOMAIN}"

# Show addon services from the generated coder-routes.yaml.
# Routers with a Host() rule have a known Coder app (slug subdomain URL).
# Routers with PathPrefix("/") are dynamic add-ons accessible via port-forwarding:
# https://{port}--{agent}--{workspace}--{owner}.{domain}
CODER_ROUTES="$HOME/.ddev/traefik/custom-global-config/coder-routes.yaml"
if [ -f "$CODER_ROUTES" ]; then
  while IFS= read -r router; do
    # Skip web and mailpit — already printed above.
    # Web router key: {project}-coder-{workspace} (slug = workspace name).
    [ "$router" = "${PROJECT}-coder-${WORKSPACE}" ] && continue
    [ "$router" = "${PROJECT}-coder-mailpit" ] && continue
    # Get first entrypoint and extract port number (http-9100 → 9100)
    entrypoint=$(yq e ".http.routers.\"${router}\".entrypoints[0] // \"\"" "$CODER_ROUTES" 2>/dev/null)
    [ -z "$entrypoint" ] || [ "$entrypoint" = "null" ] && continue
    ext_port="${entrypoint#http-}"
    # Slug is the router name with "{project}-coder-" prefix stripped
    slug="${router#${PROJECT}-coder-}"
    # Determine URL format from the rule type
    rule=$(yq e ".http.routers.\"${router}\".rule // \"\"" "$CODER_ROUTES" 2>/dev/null)
    if echo "$rule" | grep -q "^Host"; then
      # Known Coder app (Host rule): use slug subdomain URL
      echo "  ${slug}: https://${slug}--${WORKSPACE}--${OWNER}.${DOMAIN}"
    else
      # Dynamic add-on (PathPrefix rule): use Coder port-forwarding URL
      echo "  ${slug}: https://${ext_port}--${AGENT}--${WORKSPACE}--${OWNER}.${DOMAIN}"
    fi
  done < <(yq e '.http.routers | keys | .[]' "$CODER_ROUTES" 2>/dev/null)
fi

echo ""
