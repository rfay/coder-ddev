#!/usr/bin/env bash

## Description: Regenerate Coder Traefik routing rules for this DDEV project
## Usage: coder-routes
## Example: "ddev coder-routes"

# DDEV_SITENAME is set by DDEV when running as a command or hook.
# Fall back to CODER_WORKSPACE_NAME for manual invocations outside DDEV context.
PROJECT="${DDEV_SITENAME:-${CODER_WORKSPACE_NAME:-}}"
OWNER="${CODER_WORKSPACE_OWNER_NAME:-}"
DOMAIN=""
if [ -n "${VSCODE_PROXY_URI:-}" ]; then
  DOMAIN=$(echo "$VSCODE_PROXY_URI" | sed -E 's|https?://[^.]+\.(.+?)(/.*)?$|\1|')
fi

if [ -z "$PROJECT" ] || [ -z "$OWNER" ] || [ -z "$DOMAIN" ]; then
  echo "Error: required variables not set (PROJECT='$PROJECT' OWNER='$OWNER' DOMAIN='$DOMAIN')"
  exit 1
fi

# Read from the DDEV-generated merged Traefik config — it has all routers and
# service names already correctly computed (including addons), so we don't need
# to parse docker-compose files ourselves.
MERGED="${HOME}/.ddev/traefik/config/${PROJECT}_merged.yaml"
if [ ! -f "$MERGED" ]; then
  echo "Error: $MERGED not found — run ddev start first"
  exit 1
fi

mkdir -p ~/.ddev/traefik/custom-global-config

# Seed the output file
printf "http:\n  routers: {}\n" > /tmp/coder-routes-raw.yaml

echo "Building Coder Traefik routes from ${PROJECT}_merged.yaml:"

# Iterate over every router in the merged config.
# Each entry has an entrypoints list and a service name like {project}-{svc}-{port}.
while IFS= read -r router; do
  [ -z "$router" ] && continue

  service=$(yq e ".http.routers.\"${router}\".service // \"\"" "$MERGED")
  [ -z "$service" ] || [ "$service" = "null" ] && continue

  # Read entrypoints as a space-separated list
  mapfile -t entrypoints < <(yq e ".http.routers.\"${router}\".entrypoints[]" "$MERGED" 2>/dev/null)
  [ ${#entrypoints[@]} -eq 0 ] && continue

  # Derive Coder slug from service name: strip {project}- prefix and -{port} suffix.
  # Examples:
  #   mysite-web-80      → svc=web  port=80   → slug=mysite  (primary web)
  #   mysite-web-8025    → svc=web  port=8025  → slug=mailpit (mailpit in web container)
  #   mysite-adminer-8080 → svc=adminer        → slug=adminer
  svc_and_port="${service#${PROJECT}-}"
  port="${svc_and_port##*-}"
  svc_name="${svc_and_port%-*}"

  if [ "$svc_name" = "web" ] && [ "$port" = "8025" ]; then
    slug="mailpit"
  elif [ "$svc_name" = "web" ]; then
    slug="$PROJECT"
  else
    slug="$svc_name"
  fi

  CODER_HOST="${slug}--${PROJECT}--${OWNER}.${DOMAIN}"
  ROUTER_NAME="${PROJECT}-coder-${slug}"

  # Build entrypoints YAML list for yq
  ENTRY_LIST=$(printf '"%s",' "${entrypoints[@]}" | sed 's/,$//')

  RULE='Host(`'"${CODER_HOST}"'`)'
  RULE="$RULE" SVC="$service" \
    yq e -i \
      ".http.routers.\"${ROUTER_NAME}\".entrypoints = [${ENTRY_LIST}] |
       .http.routers.\"${ROUTER_NAME}\".rule = env(RULE) |
       .http.routers.\"${ROUTER_NAME}\".service = env(SVC) |
       .http.routers.\"${ROUTER_NAME}\".tls = false" \
    /tmp/coder-routes-raw.yaml

  echo "  + ${slug}: ${entrypoints[*]} → ${service}  (${CODER_HOST})"

done < <(yq e '.http.routers | keys | .[]' "$MERGED" 2>/dev/null)

yq e '.' /tmp/coder-routes-raw.yaml > ~/.ddev/traefik/custom-global-config/coder-routes.yaml
echo "✓ Wrote coder-routes.yaml"

# Push to running ddev-router; Traefik's watch:true reloads within ~1s
if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^ddev-router$"; then
  docker cp ~/.ddev/traefik/custom-global-config/coder-routes.yaml \
    ddev-router:/mnt/ddev-global-cache/traefik/config/coder-routes.yaml
  echo "✓ Pushed to ddev-router (Traefik reloads within ~1s)"
else
  echo "Note: ddev-router not running; config will be loaded on next ddev start"
fi
