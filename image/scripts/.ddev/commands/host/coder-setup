#!/usr/bin/env bash

## Description: Install Coder post-start hook into this DDEV project
## Usage: coder-setup
## Example: "ddev coder-setup"

set -euo pipefail

if [ ! -f ".ddev/config.yaml" ]; then
  echo "Error: no .ddev/config.yaml found. Run 'ddev config' first."
  exit 1
fi

# Write config.coder.yaml alongside config.yaml
cat > .ddev/config.coder.yaml << 'EOF'
# Coder-specific DDEV hooks (auto-generated by ddev coder-setup, do not edit)
hooks:
  post-start:
    - exec-host: ~/.ddev/commands/host/coder-routes
EOF
echo "✓ Wrote .ddev/config.coder.yaml"

# Gitignore it so it doesn't end up in the project repo
mkdir -p ~/.config/git
if ! grep -qF ".ddev/config.coder.yaml" ~/.config/git/ignore 2>/dev/null; then
  echo ".ddev/config.coder.yaml" >> ~/.config/git/ignore
  echo "✓ Added .ddev/config.coder.yaml to ~/.config/git/ignore"
fi

echo ""
echo "Coder routing hook installed. Run 'ddev start' to activate routing."
echo "The hook runs automatically after every 'ddev start'."
